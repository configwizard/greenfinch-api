<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Greenfinch API</title>

    <script src="https://unpkg.com/@cityofzion/neon-js@next"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha512/0.8.0/sha512.min.js" integrity="sha512-KUrAWA1oxsWKHBaA2mlZyRuR8zzzHHYgpDfkfPrT3FhlZ4YdXbXyE89VHI6WmWradSHtuZjLyLAMP2F7IWK4JQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <!-- Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/6b4fb8a528.js" crossorigin="anonymous"></script>

    <!-- 
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    -->
    <style>
        pre {
            white-space: pre-wrap;       /* Since CSS 2.1 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card ut-bgcolor">
                    <div class="card-body">
                        <div class="d-flex align-items-center" style="margin-bottom: 15px;">
                            <img class="ut-logo" src="assets/greenfinch-logo-v1.svg"><h2 class="card-title">Greenfinch API</h2>
                        </div>
                        <h5 class="card-text">This is an HTTP API into the NeoFS file system.</h5>
                        <p>Currently this has initial support for object management. Please also see the following links:</p>
                        <ul class="ut-outline">
                            <li><a class="ut-standard" target="_blank" href="https://developers.neo.org/docs/n3/neofs/introduction/Overview">The Neo Developer NeoFS Overview</a></li>
                            <li><a class="ut-standard" target="_blank" href="https://gist.github.com/amlwwalker/407a04c9b21915eee067a5531394f542#file-index-html">Code to see how to interact from JavaScript</a></li>
                            <li><a class="ut-standard" target="_blank" href="https://gist.github.com/amlwwalker/407a04c9b21915eee067a5531394f542#file-createcontainer-go">Code to create a container</a></li>
                            <li><a class="ut-standard" target="_blank" href="https://greenfinch.app">Or create a container with Greenfinch</a></li>
                            <li><a class="ut-standard" target="_blank" href="https://gist.github.com/amlwwalker/407a04c9b21915eee067a5531394f542#file-decryptaccount-js">Helper decrypting wallets for public and private key</a></li>
                        </ul>
                        <h4>Roadmap</h4>
                        <ul class="ut-outline">
                            <li>Container management (creation/deletion/list/sharing)</li>
                            <li>Larger objects</li>
                            <li>Search attributes</li>
                            <li>Shared library (.so files)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="accordion" id="accordionAPI">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingUploadObject">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUploadObject" aria-expanded="false" aria-controls="collapseUploadObject">
                                <span class="badge bg-primary">POST</span>&nbsp;Upload an object to a container
                            </button>
                        </h2>
                        <div id="collapseUploadObject" class="accordion-collapse collapse" aria-labelledby="headingUploadObject" data-bs-parent="#accordionAPI">
                            <div class="accordion-body">
                                <pre class="ut-bg">POST /object/{containerId}</pre>
                                <h3>Request</h3>
                                <h4 class="ut-uc">Headers</h4>
                                <ul>
                                    <li><pre class="ut-inline">containerId</pre><span class="ut-required">(required)</span>: The ID of the container to upload the object to</li>
                                    <li><pre class="ut-inline">publicKey</pre><span class="ut-required">(required)</span>: The public key of the container owner</li>
                                    <li><pre class="ut-inline">X-r</pre><span class="ut-required">(required)</span>: The (bigInt) r - the integer retrieved from the signature</li>
                                    <li><pre class="ut-inline">X-s</pre><span class="ut-required">(required)</span>: The (bigInt) s - the integer retrieved from the signature</li>
                                    <li><pre class="ut-inline">Content-Type: multipart/form-data</pre> Currently only multipart/form-data is supported (max. size is 32MB)</li>
                                </ul>
                                <p><strong>NB. The payload should be multipart/form-data.</strong></p>
                                <h3>Response</h3>
                                <h4 class="ut-uc">Success</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">200</span></li>
                                    <li><pre class="ut-inline">Content: {objectId}</pre></li>
                                </ul>
                                <h4 class="ut-uc">Bad Request</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">400</span></li>
                                    <li><pre class="ut-inline">Content: error message defining issue with request</pre></li>
                                </ul>
                                <h4 class="ut-uc">Server error</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">502</span></li>
                                    <li><pre class="ut-inline">Content: Issue with the session (recreate the signature)</pre></li>
                                    <li><pre class="ut-inline">Content: Issue with the payload (the payload was not of the correct content-type)</pre></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingListObjects">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseListObjects" aria-expanded="false" aria-controls="collapseListObjects">
                                <span class="badge bg-primary">GET</span>&nbsp;List all the objects in a container
                            </button>
                        </h2>
                        <div id="collapseListObjects" class="accordion-collapse collapse" aria-labelledby="headingListObjects" data-bs-parent="#accordionAPI">
                            <div class="accordion-body">
                                <pre class="ut-bg">GET /object/{containerId}</pre>
                                <h3>Request</h3>
                                <h4 class="ut-uc">Headers</h4>
                                <ul>
                                    <li><pre class="ut-inline">containerId</pre><span class="ut-required">(required)</span>: The ID of the container to list the objects in</li>
                                    <li><pre class="ut-inline">publicKey</pre><span class="ut-required">(required)</span>: The public key of the container owner</li>
                                    <li><pre class="ut-inline">X-r</pre><span class="ut-required">(required)</span>: The (bigInt) r - the integer retrieved from the signature</li>
                                    <li><pre class="ut-inline">X-s</pre><span class="ut-required">(required)</span>: The (bigInt) s - the integer retrieved from the signature</li>
                                </ul>
                                <h3>Response</h3>
                                <h4 class="ut-uc">Success</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">200</span></li>
                                    <li><pre class="ut-inline">Content: [{objectId}, {objectId}, {objectId}]</pre></li>
                                </ul>
                                <h4 class="ut-uc">Bad Request</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">400</span></li>
                                    <li><pre class="ut-inline">Content: error message defining issue with request</pre></li>
                                </ul>
                                <h4 class="ut-uc">Server error</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">502</span></li>
                                    <li><pre class="ut-inline">Content: Issue with the session (recreate the signature)</pre></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingGetObject">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGetObject" aria-expanded="false" aria-controls="collapseGetObject">
                                <span class="badge bg-primary">GET</span>&nbsp;Get an object (payload)
                            </button>
                        </h2>
                        <div id="collapseGetObject" class="accordion-collapse collapse" aria-labelledby="headingGetObject" data-bs-parent="#accordionAPI">
                            <div class="accordion-body">
                                <pre class="ut-bg">GET /object/{containerId}/{objectId}</pre>
                                <h3>Request</h3>
                                <h4 class="ut-uc">Headers</h4>
                                <ul>
                                    <li><pre class="ut-inline">containerId</pre><span class="ut-required">(required)</span>: The ID of the container that contains the object</li>
                                    <li><pre class="ut-inline">objectId</pre><span class="ut-required">(required)</span>: The ID of the object to retrieve</li>
                                    <li><pre class="ut-inline">publicKey</pre><span class="ut-required">(required)</span>: The public key of the container owner</li>
                                    <li><pre class="ut-inline">X-r</pre><span class="ut-required">(required)</span>: The (bigInt) r - the integer retrieved from the signature</li>
                                    <li><pre class="ut-inline">X-s</pre><span class="ut-required">(required)</span>: The (bigInt) s - the integer retrieved from the signature</li>
                                    <li><pre class="ut-inline">Content-Type: multipart/form-data</pre> Currently only multipart/form-data is supported</li>
                                </ul>
                                <h3>Response</h3>
                                <h4 class="ut-uc">Success</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">200</span></li>
                                    <li>Header: <pre class="ut-inline">NEOFS-META: {metadata}</pre></li>
                                    <li><pre class="ut-inline">Content: []byte</pre></li>
                                </ul>
                                <h4 class="ut-uc">Bad Request</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">400</span></li>
                                    <li><pre class="ut-inline">Content: error message defining issue with request</pre></li>
                                </ul>
                                <h4 class="ut-uc">Server error</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">502</span></li>
                                    <li><pre class="ut-inline">Content: Issue with the session (recreate the signature)</pre></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingGetObjectHead">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGetObjectHead" aria-expanded="false" aria-controls="collapseGetObjectHead">
                                <span class="badge bg-primary">HEAD</span>&nbsp;<span class="badge bg-primary">GET</span>&nbsp;Get an object's metadata
                            </button>
                        </h2>
                        <div id="collapseGetObjectHead" class="accordion-collapse collapse" aria-labelledby="headingGetObjectHead" data-bs-parent="#accordionAPI">
                            <div class="accordion-body">
                                <pre class="ut-bg">HEAD /object/{containerId}/{objectId}</pre>
                                <pre class="ut-bg">GET /object/data/{containerId}/{objectId}</pre>

                                <strong>NB. Not all servers respect the HEAD method.</strong>
                                <h3>Request</h3>
                                <h4 class="ut-uc">Headers</h4>
                                <ul>
                                    <li><pre class="ut-inline">containerId</pre><span class="ut-required">(required)</span>: The ID of the container that contains the object</li>
                                    <li><pre class="ut-inline">objectId</pre><span class="ut-required">(required)</span>: The ID of the object to retrieve the metadata of</li>
                                    <li><pre class="ut-inline">publicKey</pre><span class="ut-required">(required)</span>: The public key of the container owner</li>
                                    <li><pre class="ut-inline">X-r</pre><span class="ut-required">(required)</span>: The (bigInt) r - the integer retrieved from the signature</li>
                                    <li><pre class="ut-inline">X-s</pre><span class="ut-required">(required)</span>: The (bigInt) s - the integer retrieved from the signature</li>
                                </ul>
                                <h3>Response</h3>
                                <h4 class="ut-uc">Success</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">200</span></li>
                                    <li>Header: <pre class="ut-inline">NEOFS-META: {metadata}</pre></li>
                                </ul>
                                <h4 class="ut-uc">Bad Request</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">400</span></li>
                                    <li><pre class="ut-inline">Content: error message defining issue with request</pre></li>
                                </ul>
                                <h4 class="ut-uc">Server error</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">502</span></li>
                                    <li><pre class="ut-inline">Content: Issue with the session (recreate the signature)</pre></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingDeleteObject">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDeleteObject" aria-expanded="false" aria-controls="collapseDeleteObject">
                                <span class="badge bg-primary">DELETE</span>&nbsp;Delete an object
                            </button>
                        </h2>
                        <div id="collapseDeleteObject" class="accordion-collapse collapse" aria-labelledby="headingDeleteObject" data-bs-parent="#accordionAPI">
                            <div class="accordion-body">
                                <pre class="ut-bg">DELETE /object/{containerId}/{objectId}</pre>
                                <h3>Request</h3>
                                <h4 class="ut-uc">Headers</h4>
                                <ul>
                                    <li><pre class="ut-inline">containerId</pre><span class="ut-required">(required)</span>: The ID of the container that contains the object</li>
                                    <li><pre class="ut-inline">objectId</pre><span class="ut-required">(required)</span>: The ID of the object to delete</li>
                                    <li><pre class="ut-inline">publicKey</pre><span class="ut-required">(required)</span>: The public key of the container owner</li>
                                    <li><pre class="ut-inline">X-r</pre><span class="ut-required">(required)</span>: The (bigInt) r - the integer retrieved from the signature</li>
                                    <li><pre class="ut-inline">X-s</pre><span class="ut-required">(required)</span>: The (bigInt) s - the integer retrieved from the signature</li>
                                </ul>
                                <h3>Response</h3>
                                <h4 class="ut-uc">Success</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">204</span></li>
                                </ul>
                                <h4 class="ut-uc">Bad Request</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">400</span></li>
                                    <li><pre class="ut-inline">Content: error message defining issue with request</pre></li>
                                </ul>
                                <h4 class="ut-uc">Server error</h4>
                                <ul>
                                    <li>Response code: <span class="ut-nos">502</span></li>
                                    <li><pre class="ut-inline">Content: Issue with the session (recreate the signature)</pre></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card ut-bgcolor">
                    <div class="card-body">
                        <div class="d-flex align-items-center" style="margin-bottom: 15px;">
                            <img class="ut-logo" src="assets/greenfinch-logo-v1.svg"><h2 class="card-title">Greenfinch API Sandbox</h2>
                        </div>
                        <h5 class="card-text">Try the API here.</h5>
                        <p>In short, this API allows a container owner to interact with their container and objects over HTTP without sharing their private key.</p>
                        <p><strong>Watch a demo video of <a class="ut-standard" href="https://www.youtube.com/watch?v=0DcNxWtjDbo">using the Sandbox here</a></strong></p>
                        <p><strong>You need to have the following:</strong></p>
                        <ul>
                            <li>A containerID and the public key of the container owner</li>
                            <li>Send these to the API to receive a bearer token</li>
                            <li>Use this token and your private key to sign the bearer token</li>
                        </ul>
                        <p><strong>Now you can upload an object...</strong></p>
                        <ul>
                            <li>Or you can retrieve details of an object</li>
                            <li>Or you can list all objects</li>
                            <li>Or you can delete an object</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">1. Request new bearer token</h5>
                        <p class="card-text">Before any request you will need a bearer token. You can specify how long a token should last.</p>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Public key</span>
                            <input type="text" class="form-control" id="publicKey" aria-describedby="basic-addon3" value="">
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Container ID</span>
                            <input type="text" class="form-control" id="containerID" aria-describedby="basic-addon3" value="">
                        </div>
                        <button class="btn btn-primary" id="getBearerToken">Request token</button>
                        <span>
                            <pre id="token"></pre>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">2. Sign the bearer token</h5>
                        <p class="card-text">Now, with your private key, you need to sign the bearer token. This will respond with two integers, r and s.</p>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Private key</span>
                            <input type="password" class="form-control" id="privateKey" aria-describedby="basic-addon3" value="">
                        </div>
                        <button class="btn btn-primary" id="signToken">Sign token</button>
                        <span>
                            <pre id="signature"></pre>
                                <!-- <button onClick="getBearerToken()">Click me</button> -->
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">3. Use the signature to upload</h5>
                        <p class="card-text">Use the signature to upload some data to the contain.</p>

                        <div class="input-group mb-3">
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" href="#" type="button" id="uploadDropDown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select file type
                                </button>
                              
                                <ul class="dropdown-menu" aria-labelledby="uploadDropDownButton" id="uploadDropDownButton">
                                    <li><a class="dropdown-item upload" href="#">multipart/form-data</a></li>
                                    <li><a class="dropdown-item upload" href="#">text/plain</a></li>
                                </ul>
                                <span id="content-type-selector"></span>
                            </div>
                            <!-- 
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="uploadDropDown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select file type
                                </button>
                                <div class="dropdown-menu" aria-labelledby="uploadDropDownButton" id="uploadDropDownButton">
                                    <a class="dropdown-item upload" href="#">multipart/form-data</a>
                                    <a class="dropdown-item upload" href="#">text/plain</a>
                                </div>
                                <span id="content-type-selector"></span>
                            </div>
                            -->
                        </div>

                        <div id="multipart-upload" style="display: none;">
                        <label for="file">Choose a file to upload</label>
                        <input type="file" id="file" name="file">
                        </div>
                        <div id="rawContent-upload" style="display: none;">
                            <label for="rawContent-attributes">Set the name for the content</label><br>
                            <input type="text" class="form-control" id="rawContentFileName" aria-describedby="basic-addon3" value="shakespeare-content.json">
                            <label for="rawContent-attributes">Set the attributes for the upload</label><br>
                            <textarea rows="4" cols="50" id="rawContent-attributes">
{
    "Author Type":"Poetry/fiction"
}
                            </textarea><br />
                            <label for="raw-content">Set the data to upload</label><br>
                            <textarea rows="4" cols="50" id="raw-content">
{
    "title":"The complete works of William Shakespeare",
    "birth": "26.04.1564",
    "died": "23.04.1616"
}
                            </textarea>
                        </div>
                        <button class="btn btn-primary" id="uploadButton">Upload</button>
                        <span>
                            <pre id="uploadResponse"></pre>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">4. Use the signature to retrieve</h5>
                        <p class="card-text">The signature can now be used to make a request.<br>
                        <strong>NB. You do need to have the file type above selected first.</strong></p>
                        <div class="input-group mb-3">
                             
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" href="#" type="button" id="methodDropDown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select method
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="methodDropDownButton" id="methodDropDownButton">
                                    <li><a class="dropdown-item method" href="#">HEAD</a></li>
                                    <li><a class="dropdown-item method" href="#">GET</a></li>
                                    <li><a class="dropdown-item method" href="#">LIST</a></li>
                                    <li><a class="dropdown-item method" href="#">DELETE</a></li>
                                </ul>
                                <span id="method-type-selector"></span>
                            </div>
                            <!-- 
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="methodDropDown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Select Method
                                </button>
                                <div class="dropdown-menu" aria-labelledby="methodDropDownButton" id="methodDropDownButton">
                                    <a class="dropdown-item method" href="#">GET</a>
                                    <a class="dropdown-item method" href="#">LIST</a>
                                    <a class="dropdown-item method" href="#">DELETE</a>
                                </div>
                                <span id="method-type-selector"></span>
                            </div>
                            -->
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">Object ID</span>
                            <input type="text" class="form-control" id="objectID" aria-describedby="basic-addon3" value="">
                        </div>
                        <button class="btn btn-primary" id="requestResponse">Make request</button>
                        <button class="btn btn-primary" id="decodeContent">Decode</button>
                        <span>
                            <pre id="metadata"></pre>
                            <pre id="decodedContent"></pre>
                            <div id="displayImage"></div>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <section class="keyEmail text-center">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-md-6">
                    <i class="fa-brands fa-2x fa-discord"></i>
                    <p>How can we improve Greenfinch? Find us on <a href="https://discord.gg/EeZtA2b7PQ" title="Greenfinch Discord" target="_blank">Discord</a>.</p>
                </div>
            </div>
        </div>
    </section>

    <footer class="text-center">
		<p>&copy; 2022 Greenfinch. All rights reserved.</p>
	</footer>

</body>
<script>
    const domain = "http://localhost:9000"
    let contentTypeUpload, contentTypeDownload, methodTypeUpload = null

    // // Size should be given in 'bytes'
    // function generate_random_data(size) {
    //     return new Blob([new ArrayBuffer(size)], {type: 'application/octet-stream'});
    // };

    //consider using multipart https://stackoverflow.com/questions/50784370/javascript-create-a-file-out-of-json-object-and-use-it-in-a-formdata
    function rawContentUpload() {
        const p = document.getElementById("publicKey")
        let containerID = document.getElementById("containerID")
        console.log(containerID.value)
        let signatureArea = document.getElementById("signature").innerText
        let signature = JSON.parse(signatureArea)

        let xhttp = new XMLHttpRequest();

        xhttp.open("POST", `${domain}/api/v1/object/${containerID.value}`, true);
        if (contentTypeUpload == null) {
            alert("No content type set.")
            return false
        }
        xhttp.setRequestHeader("X-r", signature.r)
        xhttp.setRequestHeader("X-s", signature.s)
        xhttp.setRequestHeader("publicKey", p.value)
        const filename = document.getElementById("rawContentFileName").value
        //add attributes to the request
        const attributes = document.getElementById("rawContent-attributes").value
        console.log(attributes)
        xhttp.setRequestHeader("NEOFS-ATTRIBUTES", attributes.replace(/(\r\n|\n|\r)/gm, ""))
        // xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        const rawContent = document.getElementById("raw-content").value.replace(/(\r\n|\n|\r)/gm, "")
        const blob = new Blob([rawContent], { type: 'text/plain' });
        const file = new File([ blob ], filename);
        const formData = new FormData();
        formData.append('file', file, filename);
        xhttp.send(formData);
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // Typical action to be performed when the document is ready:
                console.log("response from content upload ", xhttp.responseText)
                document.getElementById("uploadResponse").innerHTML = xhttp.responseText;
            }
        };
    }
    function multipartFileUpload() {
        const p = document.getElementById("publicKey")
        let containerID = document.getElementById("containerID")
        console.log(containerID.value)
        let signatureArea = document.getElementById("signature").innerText
        let signature = JSON.parse(signatureArea)
        let formData = new FormData();
        let f = $('input[type=file]')[0].files[0]
        // HTML file input, chosen by user
        formData.append("file", f); //fileInputElement.files[0]

        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", `${domain}/api/v1/object/${containerID.value}`, true);
        if (contentTypeUpload == null) {
            alert("No content type set.")
            return false
        }
        xhttp.setRequestHeader("X-r", signature.r)
        xhttp.setRequestHeader("X-s", signature.s)
        xhttp.setRequestHeader("publicKey", p.value)
        // xhttp.setRequestHeader("Content-Type", "multipart/form-data");
        xhttp.send(formData);
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // Typical action to be performed when the document is ready:
                console.log("response from content upload ", xhttp.responseText)
                document.getElementById("uploadResponse").innerHTML = xhttp.responseText;
            }
        };
    }

    function getBearerToken() {
        const p = document.getElementById("publicKey")
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // Typical action to be performed when the document is ready:
                document.getElementById("token").innerHTML = xhttp.responseText;
            }
        };
        xhttp.open("GET", `${domain}/api/v1/bearer/${containerID.value}`, true);
        xhttp.setRequestHeader("publicKey", p.value)
        xhttp.send();
    }
    function decodeMeta() {
        const content = document.getElementById("metadata").innerText
        const decodedContent = window.atob(content)
        document.getElementById("decodedContent").innerText = decodedContent
    }
    function requestData() {

        if (methodTypeUpload == null) {
            console.log("no method set")
            return
        }
        const p = document.getElementById("publicKey")
        let containerID = document.getElementById("containerID")
        let objectID = document.getElementById("objectID")
        console.log(objectID.value)
        let signatureArea = document.getElementById("signature").innerText
        let signature = JSON.parse(signatureArea)
        let xhttp = new XMLHttpRequest();
        xhttp.responseType = "blob";
        xhttp.onreadystatechange = function() {
            console.log("state change", this.readyState, this.HEADERS_RECEIVED)
            if (this.readyState == this.HEADERS_RECEIVED) {
                // Get the raw header string
                var headers = xhttp.getAllResponseHeaders();
                console.log("headers", headers)
                var arr = headers.trim().split(/[\r\n]+/);
                // Create a map of header names to values
                var headerMap = {};
                arr.forEach(function (line) {
                    var parts = line.split(': ');
                    var header = parts.shift();
                    var value = parts.join(': ');
                    headerMap[header] = value;
                });
                console.log("metadata", headerMap["neofs-meta"])
                document.getElementById("metadata").innerText = headerMap["neofs-meta"]
            }
        };

        xhttp.onload = function(e) {
            if (this.status == 200) {
                if (contentTypeUpload == "multipart/form-data") {
                    console.log("assuming a blob")
                    // xhttp.responseType = "blob";
                    var blob = this.response;
                    console.log("blob", blob)
                    var src = document.getElementById("displayImage");
                    var img = document.createElement("img");
                    img.src = window.URL.createObjectURL(blob);
                    src.appendChild(img);
                } else if (contentTypeUpload == "text/plain") {
                    var blob = this.response;
                    blob.text().then(text => {
                        let blobText = text
                        console.log("blob", blobText)

                        var src = document.getElementById("decodedContent");
                        src.innerHTML = blobText
                    })
                }
            }
        };


        let requestUrl = `${domain}/api/v1/object/${containerID.value}/${objectID.value}`
        if (methodTypeUpload == "HEAD") {
            methodTypeUpload = "GET"
            requestUrl = `${domain}/api/v1/object/data/${containerID.value}/${objectID.value}`
        }
        if (methodTypeUpload == "LIST") {
            methodTypeUpload = "GET"
            requestUrl = `${domain}/api/v1/object/${containerID.value}`
        }
        requestUrl = requestUrl.endsWith('/') ? requestUrl.substr(0, str.length - 1) : requestUrl;
        console.log("final request url", requestUrl)
        xhttp.open(methodTypeUpload, requestUrl, true);
        xhttp.setRequestHeader("publicKey", p.value)
        xhttp.setRequestHeader("X-r", signature.r)
        xhttp.setRequestHeader("X-s", signature.s)
        xhttp.send();
    }
    function _base64ToArrayBuffer(base64) {
        var binary_string = window.atob(base64);
        var len = binary_string.length;
        var bytes = new Uint8Array(len);
        for (var i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    }
    function toHexString(byteArray) {
        return Array.from(byteArray, function(byte) {
            return ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }).join('')
    }
    function signToken() {
        const msgStr = document.getElementById("token").innerText
        const msg = JSON.parse(msgStr).token
        const privKey = document.getElementById("privateKey")
        const account = decryptAccountData(privKey.value)
        const decoededMessage = _base64ToArrayBuffer(msg)
        const curve = Neon.u.getCurve(Neon.u.EllipticCurvePreset.SECP256R1);
        const sig = curve.sign(sha512.digest(decoededMessage), account.privateKey);
        curve.verify(sha512.digest(decoededMessage), sig, Neon.wallet.getPublicKeyFromPrivateKey(account.privateKey)) ? null : console.error("warning, not able to verify signature")
        const signatureBytes = JSON.stringify(sig.toString())
        let signatureArea = document.getElementById("signature")
        signatureArea.innerText = JSON.stringify(sig)
        return sig;
    }
    function decryptAccountData(privateKey) {
        //perhaps this should require your password
        const myAccount = new Neon.wallet.Account(
            privateKey
        );
        console.log("privateKey", myAccount.privateKey)
        console.log("publickey", Neon.wallet.getPublicKeyFromPrivateKey(myAccount.privateKey));
        console.log("WIF", myAccount.WIF);
        return myAccount
    }
    document.getElementById("getBearerToken").onclick = function() {getBearerToken()};
    document.getElementById("signToken").onclick = function() {signToken()};
    document.getElementById("uploadButton").onclick = function() {
        if (contentTypeUpload == null) {
            alert("No content type selected.")
            return false
        }
        //now based on the content type and the method type, we make a decision
        if (contentTypeUpload == "multipart/form-data") {
            console.log("handling multipart")
            multipartFileUpload()
        } else if (contentTypeUpload == "text/plain") {
            console.log("handling json")
            rawContentUpload()
        }
    };
    document.getElementById("requestResponse").onclick = function() {
        requestData()
    }
    document.getElementById("decodeContent").onclick = function() {decodeMeta()};

    const uploadTypeSelector = document.querySelector("#uploadDropDownButton");
    uploadTypeSelector.addEventListener("click", (e) => {
        e.preventDefault();
        contentTypeUpload = e.target.innerText
        if (contentTypeUpload == "multipart/form-data") {
            document.getElementById("multipart-upload").style.display = "inline";
            document.getElementById("rawContent-upload").style.display = "none";
        } else if (contentTypeUpload == "text/plain") {
            document.getElementById("rawContent-upload").style.display = "inline";
            document.getElementById("multipart-upload").style.display = "none";
        }
        document.getElementById("content-type-selector").textContent = e.target.innerText
    });
    const methodTypeSelector = document.querySelector("#methodDropDownButton");
    methodTypeSelector.addEventListener("click", (e) => {
        e.preventDefault();
        methodTypeUpload = e.target.innerText
        document.getElementById("method-type-selector").textContent = e.target.innerText
    });
</script>
</html>

